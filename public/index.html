<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>POC Conversacional</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f0f2f5;
        display: flex;
        justify-content: center;
        height: 100vh;
        margin: 0;
      }
      #app {
        width: 100%;
        max-width: 500px;
        background: white;
        display: flex;
        flex-direction: column;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        height: 100%;
        max-height: 800px;
      }
      header {
        background: #0084ff;
        color: white;
        padding: 15px;
        text-align: center;
        font-weight: bold;
      }
      #chat-window {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .msg {
        padding: 10px 15px;
        border-radius: 18px;
        max-width: 75%;
        font-size: 15px;
        line-height: 1.4;
        word-wrap: break-word;
      }
      .user {
        align-self: flex-end;
        background-color: #0084ff;
        color: white;
        border-bottom-right-radius: 4px;
      }
      .bot {
        align-self: flex-start;
        background-color: #e4e6eb;
        color: #050505;
        border-bottom-left-radius: 4px;
      }
      #controls {
        padding: 20px;
        text-align: center;
        border-top: 1px solid #ddd;
        background: #fff;
      }
      button {
        padding: 15px 30px;
        font-size: 16px;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        background-color: #42b72a;
        color: white;
        font-weight: bold;
        transition: 0.2s;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }
      button:hover {
        background-color: #36a420;
        transform: scale(1.05);
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        transform: none;
      }
      .status {
        font-size: 12px;
        color: #888;
        margin-bottom: 10px;
        display: block;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <header>ü§ñ Assistente de Voz (POC)</header>

      <div id="chat-window">
        <div class="msg bot">Ol√°! Toque no bot√£o para falar.</div>
      </div>

      <div id="controls">
        <span id="status" class="status">Pronto</span>
        <button id="btnStart" onclick="startConversation()">üéôÔ∏è Falar</button>
      </div>
    </div>

    <script>
      const chatWindow = document.getElementById("chat-window");
      const btnStart = document.getElementById("btnStart");
      const statusLabel = document.getElementById("status");

      // Reconhecimento Nativo
      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition)
        alert("Navegador sem suporte a Web Speech API. Use Chrome/Edge.");

      const recognition = new SpeechRecognition();
      recognition.lang = "pt-BR";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      // Configura√ß√£o TTS (Nativo - Fallback)
      const synth = window.speechSynthesis;

      function addMessage(text, sender) {
        const div = document.createElement("div");
        div.className = `msg ${sender}`;
        div.innerText = text;
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      function setStatus(text, isProcessing = false) {
        statusLabel.innerText = text;
        btnStart.disabled = isProcessing;
        if (!isProcessing) btnStart.innerText = "üéôÔ∏è Falar";
      }

      function startConversation() {
        setStatus("Ouvindo...", true);
        btnStart.innerText = "üëÇ Ouvindo...";
        try {
          recognition.start();
        } catch (e) {
          console.error(e);
          setStatus("Erro ao iniciar microfone.");
        }
      }

      recognition.onresult = async (event) => {
        const transcript = event.results[0][0].transcript;
        addMessage(transcript, "user");

        setStatus("Processando...", true);
        btnStart.innerText = "üß† Pensando...";

        await sendToBackend(transcript);
      };

      recognition.onerror = (e) => {
        console.error("Erro STT:", e.error);
        setStatus("N√£o entendi. Tente de novo.");
      };

      recognition.onend = () => {
        if (btnStart.innerText.includes("Ouvindo")) setStatus("Pronto");
      };

      async function sendToBackend(text) {
        try {
          const response = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text }),
          });

          if (!response.ok) throw new Error("Erro na API");

          const data = await response.json();

          const botText = data.text || data.reply || "Sem resposta.";
          addMessage(botText, "bot");

          if (data.audio) {
            console.log("Modo H√≠brido detectado: Tocando MP3.");
            playServerAudio(data.audio);
          } else {
            console.log("Modo Vanilla detectado: Usando voz do navegador.");
            speakNativeBrowser(botText);
          }
        } catch (error) {
          console.error(error);
          addMessage("Erro de conex√£o.", "bot");
          setStatus("Erro.");
        }
      }

      // AWS Polly Player (Backend TTS)
      function playServerAudio(base64Audio) {
        setStatus("Reproduzindo √°udio...", true);
        btnStart.innerText = "üîä Falando...";

        const audio = new Audio("data:audio/mp3;base64," + base64Audio);

        audio.onended = () => setStatus("Pronto");
        audio.onerror = () => {
          console.error("Erro ao tocar √°udio");
          setStatus("Erro √°udio");
        };

        audio.play().catch((e) => {
          console.error("Autoplay bloqueado?", e);
          setStatus("Clique para ouvir");
        });
      }

      // Browser TTS Player (Nativo)
      function speakNativeBrowser(text) {
        if (synth.speaking) return;

        setStatus("Sintetizando voz...", true);
        btnStart.innerText = "üîä Falando...";

        const utterThis = new SpeechSynthesisUtterance(text);
        utterThis.lang = "pt-BR";

        // Tenta pegar uma voz Google se dispon√≠vel
        const voices = synth.getVoices();
        const googleVoice = voices.find(
          (v) => v.name.includes("Google") && v.lang.includes("pt-BR")
        );
        if (googleVoice) utterThis.voice = googleVoice;

        utterThis.onend = () => setStatus("Pronto");
        utterThis.onerror = () => setStatus("Erro TTS");

        synth.speak(utterThis);
      }
    </script>
  </body>
</html>
